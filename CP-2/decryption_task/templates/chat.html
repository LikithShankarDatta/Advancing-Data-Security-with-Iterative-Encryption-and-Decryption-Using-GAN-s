{% extends "base.html" %}

{% block head %}
<style>
    .messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 14px;
        background: #F9FAFB;
    }

    .messages::-webkit-scrollbar {
        width: 6px;
    }

    .messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .messages::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 10px;
    }

    .messages::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
    }

    .message {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 16px;
        font-size: 0.95em;
        position: relative;
        animation: messageSlide 0.3s ease-out;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .message:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.self {
        align-self: flex-end;
        background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.other {
        align-self: flex-start;
        background: white;
        color: #1F2937;
        border: 1px solid #E5E7EB;
        border-bottom-left-radius: 4px;
    }

    .message-user {
        font-size: 0.7em;
        margin-bottom: 4px;
        opacity: 0.8;
        font-weight: 600;
        letter-spacing: 0.3px;
    }

    .input-area {
        padding: 24px;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 1) 100%);
        border-top: 2px solid #e5e7eb;
        display: flex;
        gap: 14px;
        align-items: center;
        backdrop-filter: blur(10px);
    }

    .input-area input {
        flex: 1;
        padding: 14px 20px;
        border: 2px solid #e1e8ed;
        border-radius: 28px;
        font-size: 0.95em;
        font-family: 'Inter', sans-serif;
        transition: all 0.3s ease;
        background: white;
    }

    .input-area input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        transform: scale(1.01);
    }

    .input-area button {
        width: auto;
        padding: 14px 28px;
        border-radius: 28px;
        font-weight: 700;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .input-area button:active {
        transform: scale(0.95);
    }

    .decrypt-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2em;
        padding: 6px 10px;
        opacity: 0.6;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        filter: grayscale(0.5);
    }

    .decrypt-btn:hover {
        opacity: 1;
        transform: scale(1.3) rotate(10deg);
        filter: grayscale(0);
    }

    .decrypt-btn:active {
        transform: scale(1.1) rotate(-5deg);
    }

    .header button {
        width: auto;
        padding: 10px 18px;
        font-size: 0.8em;
        background: rgba(255, 255, 255, 0.25);
        margin-right: 12px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: none;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .header button:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .header button:active {
        transform: translateY(-1px);
    }

    .typing-indicator {
        display: none;
        padding: 12px 18px;
        background: white;
        border-radius: 20px;
        border: 2px solid #e5e7eb;
        max-width: 80px;
        align-self: flex-start;
    }

    .typing-indicator.active {
        display: block;
        animation: messageSlide 0.3s ease-out;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

    .typing-dots span {
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        animation: typingBounce 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typingBounce {

        0%,
        60%,
        100% {
            transform: translateY(0);
        }

        30% {
            transform: translateY(-10px);
        }
    }

    .decrypted {
        animation: decryptPulse 0.5s ease-out;
    }

    @keyframes decryptPulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }

    /* Particle effect container */
    #particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }

    .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(102, 126, 234, 0.6);
        border-radius: 50%;
        animation: float 3s infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0) translateX(0);
            opacity: 0;
        }

        50% {
            opacity: 1;
        }

        100% {
            transform: translateY(-100px) translateX(50px);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="particles"></div>
<div class="header">
    <span>üîê Secure Chat</span>
    <div class="header-actions">
        <button id="clearBtn" onclick="clearChat()">üóëÔ∏è Clear</button>
        <a href="/logout">Logout ({{ username }})</a>
    </div>
</div>

<div class="messages" id="messagesList">
    <!-- Messages will be loaded here -->
</div>

<div class="typing-indicator" id="typingIndicator">
    <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
    </div>
</div>

<div class="input-area">
    <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
    <button onclick="sendMessage()">Send üöÄ</button>
</div>

<script>
    const currentUser = "{{ username }}";
    let messageCount = 0;

    // Create floating particles
    function createParticles() {
        const container = document.getElementById('particles');
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 3 + 's';
            particle.style.animationDuration = (Math.random() * 2 + 2) + 's';
            container.appendChild(particle);
        }
    }

    createParticles();

    function handleKeyPress(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    }

    async function clearChat() {
        if (!confirm('üóëÔ∏è Clear all messages? This cannot be undone!')) return;

        const btn = document.getElementById('clearBtn');
        btn.textContent = '‚è≥ Clearing...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                messageCount = 0;
                const list = document.getElementById('messagesList');

                // Fade out animation
                list.style.opacity = '0';
                setTimeout(() => {
                    list.innerHTML = '';
                    list.style.opacity = '1';
                    btn.textContent = '‚úÖ Cleared!';
                    setTimeout(() => {
                        btn.textContent = 'üóëÔ∏è Clear';
                        btn.disabled = false;
                    }, 1500);
                }, 300);
            }
        } catch (error) {
            console.error('Error clearing chat:', error);
            btn.textContent = '‚ùå Error';
            setTimeout(() => {
                btn.textContent = 'üóëÔ∏è Clear';
                btn.disabled = false;
            }, 2000);
        }
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();

        if (!text) return;

        input.value = '';

        // Show typing indicator briefly
        const indicator = document.getElementById('typingIndicator');
        indicator.classList.add('active');

        try {
            const response = await fetch('/api/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });

            if (response.ok) {
                setTimeout(() => {
                    indicator.classList.remove('active');
                    loadMessages();
                }, 500);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            indicator.classList.remove('active');
        }
    }

    async function decryptMessage(text, elementId) {
        try {
            const response = await fetch('/api/decrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });

            const data = await response.json();
            if (data.decrypted) {
                const el = document.getElementById(elementId);
                const originalText = el.textContent;
                el.textContent = 'üîì ' + data.decrypted;
                el.classList.add('decrypted');
                el.style.fontWeight = 'bold';
                el.style.color = '#10b981';

                // Revert after 5 seconds
                setTimeout(() => {
                    el.textContent = originalText;
                    el.classList.remove('decrypted');
                    el.style.fontWeight = 'normal';
                    el.style.color = '';
                }, 5000);
            }
        } catch (error) {
            console.error('Error decrypting:', error);
        }
    }

    async function loadMessages() {
        try {
            const response = await fetch('/api/messages');
            const messages = await response.json();

            if (messages.length !== messageCount) {
                const list = document.getElementById('messagesList');
                const wasAtBottom = list.scrollHeight - list.scrollTop === list.clientHeight;

                list.innerHTML = '';

                messages.forEach((msg, index) => {
                    const isSelf = msg.user === currentUser;
                    const div = document.createElement('div');
                    div.className = `message ${isSelf ? 'self' : 'other'}`;

                    const textId = `msg-${index}`;

                    div.innerHTML = `
                        <div class="message-user">${msg.user}</div>
                        <span id="${textId}">${msg.text}</span>
                        <button class="decrypt-btn" onclick="decryptMessage('${msg.text.replace(/'/g, "\\'")}', '${textId}')" title="Decrypt">üîì</button>
                    `;

                    list.appendChild(div);
                });

                if (wasAtBottom || messages.length > messageCount) {
                    list.scrollTop = list.scrollHeight;
                }
                messageCount = messages.length;
            }
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    // Poll every 2 seconds
    setInterval(loadMessages, 2000);
    loadMessages();
</script>
{% endblock %}